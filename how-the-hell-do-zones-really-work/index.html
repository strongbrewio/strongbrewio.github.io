<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>How the hell does zone.js really work?</title>
    <meta name="description" content="" />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link href="/assets/css/prism.css" rel="stylesheet">

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="//how-the-hell-do-zones-really-work/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Strongbrew" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="How the hell does zone.js really work?" />
    <meta property="og:description" content="" />
    <meta property="og:url" content="//how-the-hell-do-zones-really-work/" />
    <meta property="og:image" content="/assets/images/cover/cover3.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="How the hell does zone.js really work?" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:url" content="//how-the-hell-do-zones-really-work/" />
    <meta name="twitter:image:src" content="/assets/images/cover/cover3.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Strongbrew",
    "name": "How the hell does zone.js really work?",
    "url": "//how-the-hell-do-zones-really-work/",
    "image": "/assets/images/cover/cover3.jpg",
    "description": ""
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Strongbrew" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a
                href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a
                href="/about">About</a></li>
        
            <li class="nav-fables " role="presentation"><a href="/tag/AngularJS">AngularJS</a>
        
            <li class="nav-fables " role="presentation"><a href="/tag/Angular">Angular</a>
        
            <li class="nav-fables " role="presentation"><a href="/tag/Redux">Redux</a>
        
            <li class="nav-fables " role="presentation"><a href="/tag/RxJS">RxJS</a>
        
            <li class="nav-fables " role="presentation"><a href="/tag/Typescript">Typescript</a>
        
        <li class="nav-author " role="presentation"><a
                href="/author/brechtbilliet">Brecht</a></li>
        <li class="nav-author " role="presentation"><a
                href="/author/kwintenp">Kwinten</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/cover/cover3.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/strongbrewlogo.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<div class="followme">
    <h5>Want to work with us?</h5>
    <button onclick="location.href='mailto:info@strongbrew.io';">Hire us</button>
</div>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">How the hell does zone.js really work?</h1>
            <section class="post-meta">
            <!-- <a href='/'></a> -->

            
                
            
                
                    <a href='/author/kwintenp'>Kwinten Pisman</a>
                
            
            <time class="post-date" datetime="2016-06-09">09 Jun 2016</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/Angular'>Angular</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>If you’ve read about Angular 2 change detection, you will probably have heard about zones. Zones is a feature that was ported from Dart and is used internally by Angular 2 to determine if a change detection cycle should be triggered.</p>

<p>If you go to the <a href="https://github.com/angular/zone.js/" target="_blank">github</a> page of zone.js, you can find the following definition of a Zone:</p>

<blockquote>
  <p>A Zone is an execution context that persists across async tasks. You can think of it as thread-local storage for JavaScript VMs.</p>
</blockquote>

<p>If you’re like me, this will probably not make too much sense the first time you read it. To better understand what this means, I recommend watching this talk by Brian Ford <a href="https://www.youtube.com/watch?v=3IqtmUscE_U" target="_blank">at ngConf 2014</a> and read this post by thoughtram on <a href="http://blog.thoughtram.io/angular/2016/01/22/understanding-zones.html" target="_blank">understanding zones</a>.
However, even after watching the talk and reading the blogpost, I was still intrigued to find out how this actually works. How can zone.js monkey-patch browser events and how do the examples provided on their github page really work. The purpose of this blogpost is to share what I’ve learned during my discovery.</p>

<h5 id="how-are-events-monkey-patched-and-what-does-that-even-mean">How are events monkey-patched and what does that even mean?</h5>
<p>To see how events are monkey-patched, I decided to look into the source code. The following is a simplified conceptual snippet of what zone.js does at startup time.</p>

<pre><code class="language-typescript">function zoneAwareAddEventListener() {...}
function zoneAwareRemoveEventListener() {...}
function zoneAwarePromise() {...}
function patchTimeout() {...}
window.prototype.addEventListener = zoneAwareAddEventListener;
window.prototype.removeEventListener = zoneAwareRemoveEventListener;
window.prototype.promise = zoneAwarePromise;
window.prototype.setTimeout = patchTimeout;
</code></pre>
<p><strong>NOTE:</strong> zone.js patches even more events which I omitted since the concept is the same.</p>

<p>It turns out, zone.js overrides some of the functions on the window prototype and replaces the defaults with a proxy. This means that every event scheduled or every promise created after loading the file, will be wrapped in the proxy. This concept is called monkey-patching.</p>

<h5 id="time-to-explain-by-example">Time to explain by example</h5>
<p>Lets take a look at the first example from the readme of the zone.js github repository (Here’s the <a href="http://plnkr.co/edit/Ul44DohpdBfMKjgssspw?p=preview" target="_blank">plnkr</a> you can play around with).</p>

<pre><code class="language-typescript">//load zone.js
Zone.current.fork({}).run(function () {
    Zone.current.inTheZone = true;

    setTimeout(function () {
        console.log('in the zone: ' + !!Zone.current.inTheZone);
    }, 0);
});

console.log('in the zone: ' + !!Zone.current.inTheZone);
</code></pre>

<p>If you were to execute this, you’d get the following result:</p>

<pre><code class="language-typescript">'in the zone: false'
'in the zone: true'
</code></pre>

<p>Normally, you’d expect the result of both statements to be true since we’re logging the same property in both places.</p>

<p>To understand how this works, we need to zoom in on some parts of the snippet.</p>

<h5 id="creating-and-running-something-in-a-zone">Creating and running something in a Zone</h5>
<pre><code class="language-typescript">Zone.current.fork({}).run( .... );
</code></pre>
<p>When zone.js is loaded, it creates a global property which you can use to access the root Zone. In this example, a Zone is created by forking the root Zone via the <code>Zone.current</code> property. We call the run function on the created object to run something <strong>inside this Zone</strong>.</p>

<p><img src="http://www.jacquitalbot.com/wp-content/uploads/2013/11/in-the-zone.jpg" /></p>

<h5 id="the-function-executed-in-the-zone">The function executed in the Zone</h5>
<p>Next we look at the function that is run inside the Zone.</p>

<pre><code class="language-typescript">....
Zone.current.inTheZone = true;

setTimeout(function () {
        console.log('in the zone: ' + !!Zone.current.inTheZone);
    }, 0);
....
</code></pre>

<p>It first attaches a boolean to the <code>Zone.current</code> property. It then sets up a timer to log the property after the call stack has been cleared (if you do not know what this means, I suggest looking at the following <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ" target="_blank">talk</a>).</p>
<h5 id="the-log-statement-outside-of-the-zone">The log statement outside of the Zone</h5>
<p>Lastly, the same statement is logged <strong>outside of the zone</strong>.</p>

<pre><code class="language-typescript">....
console.log('in the zone: ' + !!Zone.current.inTheZone);
</code></pre>

<p>We again point to the same <code>Zone.current</code> property. How could this not log the same result if we’re pointing to the same property in both log statements?</p>

<h5 id="zone-setup-and-teardown">Zone setup and teardown</h5>
<p>Every time something is run <strong>inside a Zone</strong> or <strong>a monkey-patched event is triggered</strong>, the Zone or the proxy <strong>sets up the Zone</strong> before executing the function or callbacks. The proxy is able to setup the Zone since it holds <strong>a reference to the Zone in which it was created</strong>.
During setup, the state linked to this specific Zone is restored so that even timeouts, event listener, … are executed like they were executed immediately. You could think of a Zone as being an <strong>execution context that persists across async tasks</strong>, as the definition states.</p>

<p>To further clarify, take a look at the next snippet. I re-arranged the code in the way it is executed and added zone setup and teardown points. Look at the comments for more information.</p>

<pre><code class="language-typescript">// load zone.js. As stated before,
// this will monkey-patch all browser events.

Zone.current.fork({}).run(function () {
    // SETUP ZONE
    // trigger: A call to the run function is made. This will first
    //          setup the zone before executing the function param.
    // actions:
    //      - Zone.current property is set to the Zone
    //        in which the function is executed. In this case, it's
    //        the one we creating by forking the root Zone. Let's
    //        call it exampleZone from this point onwards.
    //      - Zone lifecycle hooks are called (we'll get back
    //        to that later).

    // a boolean is attached to the Zone.current property. Due
    // to the zone setup, this points to the exampleZone.
    Zone.current.inTheZone = true;

    // a timeout is registered. This isn't the 'default' timeout
    // since these are monkey-patched. So here, we are actually
    // setting up the proxy. What's important to remember is that
    // this proxy will hold a reference to the Zone in which it
    // was created, in this case the 'exampleZone'. This will be
    // used later.
    setTimeout(
       ...., 0);

    // TEARDOWN ZONE
    // trigger: The function that was to be executed
    //          inside the Zone has ended.
    // actions:
    //      - Zone.current property is reset to the root Zone
    //      - Zone lifecycle hooks are called
});

// Log statement. The Zone.current property is currently
// pointing to the root Zone. Since this does not know an
// 'inTheZone' property, this will log false.
console.log('in the zone: ' + !!Zone.current.inTheZone);

// The stack is cleared and the timer callback is executed

// SETUP ZONE
// trigger: The monkey-patched event is fired. The proxy wrapper
//          will trigger a Zone setup. Remember that the proxy
//          wrapper holds a reference to the Zone in which it
//          was created.
// actions:
//      - Zone.current property is set to the exampleZone (the
//        proxy holds a reference to the exampleZone)
//      - Zone lifecycle hooks are called
function () {
        // The exampleZone does contain the 'inTheZone'
        // property. So this will log true.
        console.log('in the zone: ' + !!Zone.current.inTheZone);
}
// TEARDOWN ZONE
    // trigger: The event callback has ended and the proxy
    //          does a Zone teardown.
    // actions:
    //      - Zone.current property is reset to the root Zone
    //      - Zone lifecycle hooks are called
</code></pre>

<p>Zone.js is able to setup and teardown the Zone when executing the timeout callback thanks to the monkey-patching of that event.
This should clear things up a bit!</p>

<h6 id="how-does-angular-2-leverage-zones">How does Angular 2 leverage zones</h6>
<p>I took a look inside the Angular 2 source code to determine how they leverage zones. Take a look at the next snippet:</p>

<pre><code class="language-typescript">....
new NgZoneImpl({
      trace: enableLongStackTrace,
      onEnter: () =&gt; {
        // console.log('ZONE.enter', this._nesting, this._isStable);
        this._nesting++;
        if (this._isStable) {
          this._isStable = false;
          this._onUnstable.emit(null);
        }
      },
      onLeave: () =&gt; {
        this._nesting--;
        // console.log('ZONE.leave', this._nesting, this._isStable);
        this._checkStable();
      },
      setMicrotask: (hasMicrotasks: boolean) =&gt; {
        this._hasPendingMicrotasks = hasMicrotasks;
        this._checkStable();
      },
      setMacrotask: (hasMacrotasks: boolean) =&gt;
            { this._hasPendingMacrotasks = hasMacrotasks; },
      onError: (error: NgZoneError) =&gt;
            this._onErrorEvents.emit(error)
    });
....
</code></pre>

<p>This is from the <a href="https://github.com/angular/angular/blob/master/packages/core/src/zone/ng_zone.ts" target="_blank">NgZone.ts</a> source file. Zone.js exposes lifecycle hooks. This is a listing of the events Angular 2 listens to. Since everything in Angular 2 is run in a single Zone, ngZone, Angular 2 can leverage this to determine when it should perform a Change Detection cycle based on those callbacks. This removes the need to manually call <code>$digest</code> like in Angular 1.
Pretty neat right!</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
                
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/kwintenp" style="background-image: url(/assets/images/kwintenp.jpg)"><span class="hidden">kwintenp's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/kwintenp">Kwinten Pisman</a></h4>

                        
                            <p> Freelance frontend architect. Occasional blogger. Reactive fan.</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Belgium</span>
                            <span class="author-link icon-link"><a href="https://twitter.com/kwintenp"> twitter.com/kwintenp</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=How the hell does zone.js really work?&amp;url=how-the-hell-do-zones-really-work"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=how-the-hell-do-zones-really-work"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=how-the-hell-do-zones-really-work"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'brechtbilliet'; // required: replace example with your forum shortname
        var disqus_identifier = '/how-the-hell-do-zones-really-work/';
        var disqus_url = '/how-the-hell-do-zones-really-work/';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/cover/cover4.jpg)" href="/how-to-write-clean-reducers-and-test-them">
            <section class="post">
                <h2>How to write clean reducers (and test them!)</h2>
                <p>Last week, someone asked me how I kept my reducers clean and how to properly...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/cover/cover2.jpg)" href="/the-smart-vs-dumb-components-quiz">
            <section class="post">
                <h2>The smart vs dumb component quiz</h2>
                <p>If you follow the blogs of some of the more well known SPA guru’s, you...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Strongbrew</a> &copy; 2018</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/myjekyll/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-76318751-3', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>
    <script type="text/javascript" src="/assets/js/prism.js"></script>
</body>
</html>
